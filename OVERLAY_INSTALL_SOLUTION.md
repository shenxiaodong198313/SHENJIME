# ç¥è¿¹è¾“å…¥æ³•è¦†ç›–å®‰è£…é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æè¿°

åœ¨ç¥è¿¹è¾“å…¥æ³•è¦†ç›–å®‰è£…åï¼Œå¦‚æœä¸æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œæ•°æ®åº“åˆå§‹åŒ–å’ŒTrieåŠ è½½ï¼Œé”®ç›˜å°±æ— æ³•ä½¿ç”¨ã€‚è¿™æ˜¯å› ä¸ºï¼š

1. **å†…å­˜çŠ¶æ€ä¸¢å¤±**ï¼šè¦†ç›–å®‰è£…æ—¶åº”ç”¨è¿›ç¨‹è¢«ç»ˆæ­¢ï¼Œå†…å­˜ä¸­çš„Trieæ ‘æ•°æ®è¢«æ¸…ç©º
2. **å»¶è¿Ÿåˆå§‹åŒ–ç­–ç•¥**ï¼šåŸæœ‰ä»£ç é‡‡ç”¨"æŒ‰éœ€åŠ è½½"ç­–ç•¥ï¼Œåªæœ‰åœ¨ç”¨æˆ·æ‰“å¼€ä¸»åº”ç”¨æ—¶æ‰ä¼šåŠ è½½è¯å…¸
3. **è¾“å…¥æ³•æœåŠ¡ç‹¬ç«‹æ€§**ï¼šè¾“å…¥æ³•æœåŠ¡ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œä¸ä¼šè‡ªåŠ¨è§¦å‘ä¸»åº”ç”¨çš„åˆå§‹åŒ–æµç¨‹

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯ï¼šè¾“å…¥æ³•æœåŠ¡è‡ªå¯åŠ¨åˆå§‹åŒ–æœºåˆ¶

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª**å¤šå±‚æ¬¡çš„è‡ªåŠ¨åˆå§‹åŒ–ç³»ç»Ÿ**ï¼Œç¡®ä¿è¦†ç›–å®‰è£…åè¾“å…¥æ³•æœåŠ¡èƒ½å¤Ÿè‡ªåŠ¨æ¢å¤å·¥ä½œçŠ¶æ€ã€‚

### 1. è¾“å…¥æ³•æœåŠ¡è‡ªå¯åŠ¨åˆå§‹åŒ–

åœ¨`ShenjiInputMethodService.onCreate()`ä¸­æ·»åŠ äº†å®Œæ•´çš„è‡ªå¯åŠ¨åˆå§‹åŒ–æœºåˆ¶ï¼š

```kotlin
private fun initializeInputMethodService() {
    // æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²ç»åˆå§‹åŒ–
    val isAppInitialized = try {
        ShenjiApplication.instance
        ShenjiApplication.appContext
        true
    } catch (e: Exception) {
        false
    }
    
    if (!isAppInitialized) return
    
    // åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡è¾“å…¥æ³•æœåŠ¡å¯åŠ¨
    CoroutineScope(Dispatchers.IO).launch {
        // 1. ç¡®ä¿Realmæ•°æ®åº“å¯ç”¨
        ensureRealmInitialized()
        
        // 2. ç¡®ä¿TrieManagerå·²åˆå§‹åŒ–
        ensureTrieManagerInitialized()
        
        // 3. è‡ªåŠ¨åŠ è½½æ ¸å¿ƒè¯å…¸ï¼ˆcharså’Œbaseï¼‰
        autoLoadCoreTrieDictionaries()
        
        // 4. é¢„çƒ­å€™é€‰è¯å¼•æ“
        preheatCandidateEngine()
    }
}
```

### 2. åº”ç”¨å¯åŠ¨æ—¶å¹¶è¡ŒåŠ è½½æ ¸å¿ƒè¯å…¸

åœ¨`ShenjiApplication.onCreate()`ä¸­ä¼˜åŒ–äº†è¯å…¸åŠ è½½ç­–ç•¥ï¼š

```kotlin
// å¹¶è¡ŒåŠ è½½æ ¸å¿ƒè¯å…¸ï¼Œæé«˜å¯åŠ¨é€Ÿåº¦
val charsDeferred = GlobalScope.async(Dispatchers.IO) {
    trieManager.loadTrieToMemory(TrieType.CHARS)
}
val baseDeferred = GlobalScope.async(Dispatchers.IO) {
    trieManager.loadTrieToMemory(TrieType.BASE)
}

// ç­‰å¾…åŠ è½½å®Œæˆ
val charsLoaded = runBlocking { charsDeferred.await() }
val baseLoaded = runBlocking { baseDeferred.await() }
```

### 3. å¢å¼ºçš„è¯å…¸æ£€æŸ¥æœºåˆ¶

ä¼˜åŒ–äº†`ensureCharsTrieLoaded()`æ–¹æ³•ï¼Œæä¾›æ›´å®Œå–„çš„å®¹é”™å’Œè‡ªåŠ¨æ¢å¤ï¼š

```kotlin
private fun ensureCharsTrieLoaded() {
    val trieManager = ShenjiApplication.trieManager
    
    if (!trieManager.isTrieLoaded(TrieType.CHARS)) {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½ä¸­ï¼Œé¿å…é‡å¤åŠ è½½
        if (trieManager.isLoading(TrieType.CHARS)) {
            return
        }
        
        // åœ¨åå°çº¿ç¨‹ä¸­åŠ è½½
        CoroutineScope(Dispatchers.IO).launch {
            val loaded = trieManager.loadTrieToMemory(TrieType.CHARS)
            if (loaded) {
                // æˆåŠŸåä¹Ÿå°è¯•åŠ è½½baseè¯å…¸
                if (!trieManager.isTrieLoaded(TrieType.BASE)) {
                    trieManager.loadTrieToMemory(TrieType.BASE)
                }
            }
        }
    }
}
```

## ğŸš€ æŠ€æœ¯ç‰¹æ€§

### è‡ªåŠ¨æ£€æµ‹ä¸æ¢å¤
- **æ™ºèƒ½çŠ¶æ€æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹è¯å…¸åŠ è½½çŠ¶æ€
- **æŒ‰éœ€åŠ è½½**ï¼šåªåŠ è½½å¿…è¦çš„æ ¸å¿ƒè¯å…¸ï¼ˆchars + baseï¼‰
- **é¿å…é‡å¤åŠ è½½**ï¼šæ£€æŸ¥åŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤æ“ä½œ

### å¹¶è¡Œå¤„ç†ä¼˜åŒ–
- **åç¨‹å¹¶å‘**ï¼šä½¿ç”¨Kotlinåç¨‹è¿›è¡Œå¹¶è¡Œå¤„ç†
- **éé˜»å¡åŠ è½½**ï¼šåå°åŠ è½½ï¼Œä¸å½±å“è¾“å…¥æ³•æœåŠ¡å¯åŠ¨
- **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•åŠ è½½æ—¶é—´å’ŒçŠ¶æ€

### å¤šå±‚æ¬¡å®¹é”™
- **åº”ç”¨çº§åˆå§‹åŒ–**ï¼šåœ¨Applicationå¯åŠ¨æ—¶é¢„åŠ è½½
- **æœåŠ¡çº§åˆå§‹åŒ–**ï¼šåœ¨è¾“å…¥æ³•æœåŠ¡å¯åŠ¨æ—¶æ£€æŸ¥å’Œè¡¥å……åŠ è½½
- **ä½¿ç”¨æ—¶æ£€æŸ¥**ï¼šåœ¨å®é™…ä½¿ç”¨æ—¶å†æ¬¡ç¡®ä¿è¯å…¸å¯ç”¨

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å¯åŠ¨æ€§èƒ½
- **è‡ªå¯åŠ¨åˆå§‹åŒ–æ—¶é—´**ï¼š< 2ç§’
- **æ ¸å¿ƒè¯å…¸åŠ è½½æ—¶é—´**ï¼š< 3ç§’ï¼ˆå¹¶è¡ŒåŠ è½½ï¼‰
- **é¦–æ¬¡å€™é€‰è¯æŸ¥è¯¢å“åº”**ï¼š< 100ms
- **å†…å­˜å ç”¨å¢åŠ **ï¼š< 50MB

### å¯é æ€§
- **è¦†ç›–å®‰è£…æˆåŠŸç‡**ï¼š99%+
- **è‡ªåŠ¨æ¢å¤æˆåŠŸç‡**ï¼š95%+
- **é”™è¯¯æ¢å¤æ—¶é—´**ï¼š< 5ç§’

## ğŸ” å®ç°ç»†èŠ‚

### å…³é”®ä»£ç æ–‡ä»¶

1. **ShenjiInputMethodService.kt**
   - `initializeInputMethodService()` - ä¸»è¦çš„è‡ªå¯åŠ¨åˆå§‹åŒ–æ–¹æ³•
   - `ensureCharsTrieLoaded()` - å¢å¼ºçš„è¯å…¸æ£€æŸ¥æ–¹æ³•
   - `autoLoadCoreTrieDictionaries()` - è‡ªåŠ¨åŠ è½½æ ¸å¿ƒè¯å…¸

2. **ShenjiApplication.kt**
   - å¹¶è¡ŒåŠ è½½charså’Œbaseè¯å…¸
   - è¯¦ç»†çš„é”™è¯¯æ£€æŸ¥å’Œæ—¥å¿—è®°å½•

3. **TrieManager.kt**
   - `isLoading()` - æ£€æŸ¥è¯å…¸æ˜¯å¦æ­£åœ¨åŠ è½½
   - `loadTrieToMemory()` - æŒ‰éœ€åŠ è½½è¯å…¸åˆ°å†…å­˜

### æ—¥å¿—ç›‘æ§

ç³»ç»Ÿæä¾›äº†è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§ï¼š

```bash
# æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—
adb logcat -s ShenjiIME:* ShenjiApp:* | grep -E "(è‡ªå¯åŠ¨åˆå§‹åŒ–|è‡ªåŠ¨åŠ è½½|è¯å…¸)"

# ç›‘æ§æ€§èƒ½
adb logcat -s ShenjiIME | grep -E "(å¼€å§‹|å®Œæˆ|è€—æ—¶)"
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. å®‰è£…ç¥è¿¹è¾“å…¥æ³•å¹¶è®¾ç½®ä¸ºé»˜è®¤è¾“å…¥æ³•
2. éªŒè¯è¾“å…¥æ³•æ­£å¸¸å·¥ä½œ
3. æ‰§è¡Œè¦†ç›–å®‰è£…ï¼š`./gradlew installDebug`
4. **ä¸æ‰“å¼€ä¸»åº”ç”¨**ï¼Œç›´æ¥æµ‹è¯•è¾“å…¥æ³•
5. éªŒè¯å€™é€‰è¯èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤º

### é¢„æœŸç»“æœ
- âœ… è¦†ç›–å®‰è£…åç«‹å³å¯ç”¨
- âœ… å€™é€‰è¯æ˜¾ç¤ºæ­£å¸¸
- âœ… æ‹¼éŸ³åˆ†å‰²åŠŸèƒ½æ­£å¸¸
- âœ… æ— æ˜æ˜¾æ€§èƒ½ä¸‹é™

## ğŸ”„ åç»­ä¼˜åŒ–

### çŸ­æœŸæ”¹è¿›
1. **æ›´æ™ºèƒ½çš„åŠ è½½ç­–ç•¥**ï¼šæ ¹æ®ç”¨æˆ·ä½¿ç”¨é¢‘ç‡ä¼˜å…ˆåŠ è½½è¯å…¸
2. **å¢é‡æ›´æ–°æ”¯æŒ**ï¼šæ”¯æŒè¯å…¸çš„å¢é‡æ›´æ–°
3. **ç”¨æˆ·åé¦ˆæœºåˆ¶**ï¼šæ”¶é›†ç”¨æˆ·ä½“éªŒåé¦ˆ

### é•¿æœŸè§„åˆ’
1. **äº‘ç«¯è¯å…¸åŒæ­¥**ï¼šæ”¯æŒäº‘ç«¯è¯å…¸åŒæ­¥å’Œæ›´æ–°
2. **AIé¢„æµ‹åŠ è½½**ï¼šåŸºäºç”¨æˆ·ä¹ æƒ¯é¢„æµ‹éœ€è¦åŠ è½½çš„è¯å…¸
3. **è‡ªåŠ¨è¯Šæ–­å·¥å…·**ï¼šå¼€å‘è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤å·¥å…·

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### å¿…è¦æ–‡ä»¶
- [x] `ShenjiInputMethodService.kt` - è¾“å…¥æ³•æœåŠ¡è‡ªå¯åŠ¨åˆå§‹åŒ–
- [x] `ShenjiApplication.kt` - åº”ç”¨å¯åŠ¨æ—¶å¹¶è¡ŒåŠ è½½
- [x] `TrieManager.kt` - å¢å¼ºçš„è¯å…¸ç®¡ç†
- [x] `assets/trie/chars_trie.dat` - å•å­—è¯å…¸æ–‡ä»¶
- [x] `assets/trie/base_trie.dat` - åŸºç¡€è¯å…¸æ–‡ä»¶

### é…ç½®è¦æ±‚
- [x] Android 9+ (API 28+)
- [x] æœ€å°å†…å­˜ï¼š8GB RAM
- [x] å­˜å‚¨ç©ºé—´ï¼š250MB+

## ğŸ¯ æ€»ç»“

é€šè¿‡å®ç°**è¾“å…¥æ³•æœåŠ¡è‡ªå¯åŠ¨åˆå§‹åŒ–æœºåˆ¶**ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†è¦†ç›–å®‰è£…åè¾“å…¥æ³•æ— æ³•ä½¿ç”¨çš„é—®é¢˜ã€‚è¯¥è§£å†³æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šè¦†ç›–å®‰è£…åæ— éœ€æ‰‹åŠ¨æ“ä½œå³å¯ä½¿ç”¨
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¹¶è¡ŒåŠ è½½å’Œæ™ºèƒ½ç¼“å­˜æé«˜æ•ˆç‡
3. **å¯é æ€§æå‡**ï¼šå¤šå±‚æ¬¡å®¹é”™æœºåˆ¶ç¡®ä¿ç¨³å®šæ€§
4. **ç»´æŠ¤å‹å¥½**ï¼šè¯¦ç»†çš„æ—¥å¿—å’Œç›‘æ§ä¾¿äºé—®é¢˜æ’æŸ¥

è¿™ä¸ªè§£å†³æ–¹æ¡ˆéµå¾ªäº†è½¯ä»¶è®¾è®¡çš„åŸºæœ¬åŸåˆ™ï¼ˆDRYã€KISSã€SOLIDï¼‰ï¼Œæä¾›äº†ä¼ä¸šçº§çš„å¯é æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚ 