# 分段匹配功能测试文档

## 功能概述

为了解决长句子拼音输入无法找到候选词的问题，我们实现了分段匹配功能。该功能将长拼音字符串分解为多个独立的词组片段，分别查询候选词，从而提供更好的用户体验。

## 问题背景

### 原始问题
当用户输入长句子拼音如 `wofaxianshujukuyouwenti`（我发现数据库有问题）时，系统无法找到候选词，因为：

1. 系统试图寻找完整匹配整个句子拼音的词条
2. 词典中不存在这样的长句子词条
3. 缺乏分段处理机制

### 期望结果
理想情况下，系统应该能够：
- 识别词组边界：wo | faxian | shujuku | you | wenti
- 生成候选词：我、发现、数据库、有、问题
- 提供组合建议：我发现、数据库、有问题等

## 解决方案

### 1. 统一拼音拆分器增强
在 `UnifiedPinyinSplitter` 中新增：

#### 分段拆分功能
```kotlin
fun splitIntoSegments(input: String): List<List<String>>
fun getSegmentedSplitOptions(input: String): List<List<List<String>>>
```

#### 核心算法
- **主要分段方案**：优先较长的词组分段
- **细粒度分段**：更短的分段（1-2个音节）
- **固定长度分段**：按固定长度分割作为备选

### 2. 候选词管理器优化
在 `CandidateManager` 中新增：

#### 分段匹配查询
```kotlin
private suspend fun queryWithSegmentedMatching(input: String, limit: Int): List<WordFrequency>
```

#### 匹配策略
- **长句子检测**：输入长度 > 12 字符时启用分段匹配
- **权重加成**：为不同长度的分段提供不同的权重加成
- **多重查询**：精确匹配 + 前缀匹配 + 单字查询

### 3. 测试界面增强
在 `PinyinTestFragment` 中新增：

#### 分段显示
- 观察分段拆分结果
- 显示分段匹配详情
- 实时性能监控

## 测试用例

### 基础测试
| 输入 | 期望分段 | 说明 |
|------|----------|------|
| `wofaxianwenti` | wo + faxian + wenti | 我发现问题 |
| `nihaoshijie` | ni + hao + shi + jie | 你好世界 |
| `zhongguorenmin` | zhong + guo + ren + min | 中国人民 |

### 长句子测试
| 输入 | 期望分段数 | 说明 |
|------|------------|------|
| `wofaxianshujukuyouwenti` | ≥3 | 我发现数据库有问题 |
| `nihaoshijiehenmeihao` | ≥2 | 你好世界很美好 |
| `zhongguorenmindaxuexue` | ≥2 | 中国人民大学学 |

## 性能优化

### 权重策略
```kotlin
val bonus = when {
    segment.size == 1 -> 1.5 // 单字加成
    segment.size == 2 -> 2.0 // 双字词加成
    segment.size >= 3 -> 2.5 // 多字词加成
    else -> 1.0
}
```

### 查询限制
- 前缀匹配限制为3个结果
- 总候选词限制为 `limit * 2`
- 提前终止机制避免过度查询

## 测试验证

### 自动化测试
在 `PinyinOptimizationTestSuite` 中添加：
- 分段拆分功能测试
- 分段选项生成测试
- 异常处理测试

### 手动测试步骤
1. 打开神迹输入法应用
2. 进入"拼音测试"界面
3. 输入长句子拼音：`wofaxianshujukuyouwenti`
4. 观察分段拆分结果和候选词

### 预期结果
- 显示分段拆分：wo + fa + xian + shu + ju + ku + you + wen + ti
- 生成相关候选词：我、发现、数据库、有、问题等
- 查询过程显示分段匹配详情

## 技术细节

### 分段算法
1. **长度检测**：输入 > 12 字符启用分段模式
2. **分段查找**：从长到短尝试有效分段（最大12字符）
3. **有效性检查**：所有音节有效且长度合理（1-4音节）
4. **回退机制**：无法分段时使用部分拆分

### 查询优化
1. **多阶段查询**：精确匹配 → 前缀匹配 → 单字查询
2. **去重处理**：使用 `seenWords` 避免重复候选词
3. **权重排序**：按调整后的权重排序结果

## 后续改进

### 可能的优化方向
1. **智能分词**：基于词频和上下文的更智能分段
2. **缓存优化**：缓存分段结果提高性能
3. **用户学习**：记录用户选择习惯优化分段策略
4. **语义分析**：结合语义信息提高分段准确性

### 性能监控
- 分段匹配命中率
- 平均分段数量
- 查询响应时间
- 用户满意度

## 总结

分段匹配功能成功解决了长句子拼音输入的问题，通过智能分段和多重查询策略，显著提升了用户体验。该功能已集成到统一拼音拆分器中，并通过完整的测试套件验证了其有效性。 