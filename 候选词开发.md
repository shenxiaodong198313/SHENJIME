# 神迹输入法候选词生成功能技术文档

## 一、功能概述

本次开发实现了神迹输入法的智能候选词生成功能，替换了原有的硬编码模拟数据。系统根据不同的输入场景，动态选择合适的候选词生成策略，从Realm数据库中查询相关词条并按照词频排序，提供更智能、更准确的候选词推荐。

## 二、架构设计

### 1. 整体架构

采用策略模式实现不同场景下的候选词生成逻辑，主要包含四个核心组件：

- **候选词策略接口**：定义候选词生成的通用接口
- **具体策略实现**：四种针对不同输入场景的策略
- **候选词管理器**：协调不同策略的选择和调用
- **输入法服务集成**：将候选词功能集成到现有输入法服务中

### 2. 类图关系

```
CandidateStrategy (interface)
    ├── SingleCharStrategy
    ├── PinyinCompletionStrategy
    ├── SyllableSplitStrategy
    └── InitialAbbreviationStrategy

CandidateManager
    └── 使用并管理上述策略

ShenjiInputMethodService
    └── 通过CandidateManager调用候选词生成功能
```

### 3. 数据流

```
用户输入 → ShenjiInputMethodService → CandidateManager → 选择适用的策略
→ 从Realm数据库查询 → 候选词结果展示到UI
```

## 三、核心组件实现

### 1. 候选词策略接口（CandidateStrategy）

定义了候选词生成的核心方法：
- `isApplicable(input: String)`: 判断策略是否适用于给定输入
- `generateCandidates(input: String, limit: Int)`: 生成候选词列表

### 2. 具体策略实现

#### (1) 单字母输入策略（SingleCharStrategy）

- **适用条件**：输入长度为1的合法拼音字母
- **实现逻辑**：
  - 优先查询单字词典获取以该字母开头的单字
  - 补充查询短语词典中以该字母开头的常用词组
  - 按词频降序排列结果

#### (2) 拼音补全策略（PinyinCompletionStrategy）

- **适用条件**：输入长度>1且能够完整分词为拼音音节
- **实现逻辑**：
  - 规范化拼音输入（确保音节间有空格）
  - 根据输入长度应用不同查询范围：
    * 2-3字符：优先查询单字和基础词典
    * 4-5字符：扩展到关联词典
    * 5字符以上：查询所有词典
  - 按词频排序候选词

#### (3) 音节拆分策略（SyllableSplitStrategy）

- **适用条件**：标准拼音分词失败，但可部分拆分为有效音节
- **实现逻辑**：
  - 采用贪婪匹配，从左到右尝试匹配最长的有效音节
  - 分别查询每个拆分部分的候选词
  - 使用笛卡尔积组合生成最终候选词
  - 处理特殊情况和边界条件

#### (4) 首字母缩写策略（InitialAbbreviationStrategy）

- **适用条件**：输入长度≥2，且符合首字母缩写模式（纯小写字母无空格）
- **实现逻辑**：
  - 直接查询数据库中的initialLetters字段完全匹配项
  - 如果结果较少，查询包含该首字母序列的词条
  - 结果不足时尝试单字组合生成候选词
  - 按词频排序结果

### 3. 候选词管理器（CandidateManager）

- **职责**：协调不同候选词生成策略的选择和使用
- **核心方法**：
  - `generateCandidates(input: String, limit: Int)`: 生成指定数量的候选词
  - `selectStrategy(input: String)`: 根据输入选择最适合的策略

### 4. 应用程序入口（ShenjiApplication）

- 添加全局候选词管理器单例实例
- 确保在应用启动时正确初始化所有组件

### 5. 输入法服务集成（ShenjiInputMethodService）

- 移除硬编码模拟数据
- 通过协程异步调用候选词管理器
- 添加加载中状态提示
- 处理异常情况，确保用户体验流畅

## 四、核心算法

### 1. 拼音分词处理

利用现有的PinyinSplitter工具实现拼音分词，将无空格拼音转换为标准音节格式，如"nihao" → "ni hao"。

### 2. 音节有效性验证

通过PinyinSyllableManager验证音节是否在标准拼音音节表中。

### 3. 策略选择逻辑

按优先级顺序尝试每种策略，一旦找到适用的策略就使用它生成候选词，确保最适合的策略被选择。

### 4. 候选词排序

所有策略都按词频降序排列候选词，确保最常用的词出现在前面。

## 五、关键技术亮点

1. **策略模式应用**：通过策略模式实现不同输入场景下的候选词生成逻辑，使代码更具可扩展性
2. **协程异步处理**：使用Kotlin协程进行异步数据库查询，避免阻塞UI线程
3. **分级查询策略**：根据输入长度和类型选择不同词典组合，提高查询效率
4. **全局单例优化**：使用全局单例模式减少重复实例化
5. **健壮的异常处理**：在各个层面添加异常捕获和处理，提高系统稳定性

## 六、未来优化方向

1. **性能优化**：针对大型词典进行更精细的查询优化
2. **用户自定义词库**：添加用户词库功能，支持自学习常用词
3. **上下文感知**：结合输入上下文提供更智能的候选词推荐
4. **模糊拼音支持**：增加对拼音输入错误的容错能力
5. **候选词缓存**：实现高频查询的缓存机制，进一步提高响应速度

## 七、总结

本次开发使用策略模式成功实现了神迹输入法的候选词生成功能，为用户提供智能、准确的中文输入体验。通过合理的架构设计和模式应用，系统具有良好的可扩展性和可维护性，为未来功能扩展奠定了基础。 